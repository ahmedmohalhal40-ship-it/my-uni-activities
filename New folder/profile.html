<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملفي الشخصي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="profile-card" class="bg-white shadow-2xl rounded-3xl p-8 w-full max-w-md hidden">
        <div class="text-center mb-6">
            <div class="w-24 h-24 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-bold">
                <span id="initials">--</span>
            </div>
            <h2 id="display-name" class="text-2xl font-bold text-gray-800">جاري التحميل...</h2>
            <p id="display-username" class="text-blue-500 font-medium"></p>
        </div>

        <div class="space-y-4 border-t pt-6 text-right">
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                <span class="text-gray-500">الفرقة:</span>
                <span id="display-year" class="font-bold text-gray-800">--</span>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                <span class="text-gray-500">الشعبة:</span>
                <span id="display-section" class="font-bold text-gray-800">--</span>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                <span class="text-gray-500">نوع الحساب:</span>
                <span id="display-role" class="px-2 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold">طالب</span>
            </div>
        </div>

        <button onclick="logout()" class="w-full mt-8 bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-xl transition">
            تسجيل الخروج
        </button>
<button onclick="window.location.href='admin.html'" class="w-full mt-2 bg-gray-800 text-white font-bold py-3 rounded-xl transition">لوحة تحكم الأدمن</button>
    </div>

    <div id="loading-msg" class="text-gray-500 animate-pulse">جاري التحقق من هويتك...</div>

    <script>
        const supabaseUrl = 'https://laddhhupcublqpbcklyn.supabase.co';
        const supabaseKey = 'sb_publishable_wMLIZBnNAXFU4lvHt8B8tA_xbgQZhEH';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function loadProfile() {
            // 1. التأكد إن فيه يوزر عامل Login حالياً
            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                alert("إنت مش مسجل دخول! هحولك لصفحة التسجيل.");
                window.location.href = 'index.html';
                return;
            }

            // 2. سحب البيانات من جدول users بناءً على الـ ID
            const { data: profile, error } = await _supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error) {
                console.error("Error fetching profile:", error);
                return;
            }

            // 3. عرض البيانات في الصفحة
            document.getElementById('display-name').innerText = profile.full_name;
            document.getElementById('display-username').innerText = "@" + profile.username;
            document.getElementById('display-year').innerText = "الفرقة " + profile.year;
            document.getElementById('display-section').innerText = profile.section;
            document.getElementById('initials').innerText = profile.full_name.charAt(0);
            
            // إظهار الكارت وإخفاء رسالة التحميل
            document.getElementById('profile-card').classList.remove('hidden');
            document.getElementById('loading-msg').classList.add('hidden');
        }

        async function logout() {
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        loadProfile();
    </script>
</body>
</html>