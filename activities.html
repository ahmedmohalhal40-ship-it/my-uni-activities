<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-10 bg-white p-6 rounded-2xl shadow-sm">
            <h1 class="text-2xl font-bold text-gray-800">Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ğŸ“</h1>
            <a href="profile.html" class="text-blue-600 font-bold hover:underline">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
        </header>

        <div id="activities-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <p class="text-center text-gray-500 animate-pulse col-span-full">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©...</p>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://laddhhupcublqpbcklyn.supabase.co';
        const supabaseKey = 'sb_publishable_wMLIZBnNAXFU4lvHt8B8tA_xbgQZhEH';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function loadActivities() {
            const container = document.getElementById('activities-list');
            
            // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            const { data: activities, error } = await _supabase.from('activities').select('*');

            if (error) {
                container.innerHTML = "<p class='text-red-500 text-center'>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</p>";
                return;
            }

            if (activities.length === 0) {
                container.innerHTML = "<p class='text-gray-500 text-center col-span-full'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                return;
            }

            container.innerHTML = '';
            activities.forEach(act => {
                // Ø¹Ù…Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ (Dropdown)
                let options = act.dates.map(date => `<option value="${date}">${date}</option>`).join('');

                const card = `
                    <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-blue-500 hover:shadow-lg transition">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${act.title}</h3>
                        <p class="text-gray-600 text-sm mb-4">${act.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.'}</p>
                        
                        <div class="mb-4">
                            <label class="block text-xs text-gray-400 mb-1">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨:</label>
                            <select id="date-${act.id}" class="w-full p-2 bg-gray-50 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                                ${options}
                            </select>
                        </div>

                        <button onclick="register('${act.id}')" id="btn-${act.id}" 
                            class="w-full bg-blue-600 text-white py-2 rounded-xl font-bold hover:bg-blue-700 transition">
                            ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·
                        </button>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        async function register(activityId) {
            const btn = document.getElementById(`btn-${activityId}`);
            const selectedDate = document.getElementById(`date-${activityId}`).value;
            
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";

            // 1. Ù†Ø¹Ø±Ù Ù…ÙŠÙ† Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„Ù„ÙŠ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹
            const { data: { user } } = await _supabase.auth.getUser();

            if (!user) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
                window.location.href = 'login.html';
                return;
            }

            // 2. Ù†Ø­Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ registrations
            const { error } = await _supabase.from('registrations').insert([{
                student_id: user.id,
                activity_id: activityId,
                selected_date: selectedDate
            }]);

            if (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                btn.disabled = false;
                btn.innerText = "ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·";
            } else {
                btn.innerText = "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­";
                btn.className = "w-full bg-green-500 text-white py-2 rounded-xl font-bold cursor-default";
                alert("Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù†Ø´Ø§Ø·.");
            }
        }

        loadActivities();
    </script>
</body>
</html>