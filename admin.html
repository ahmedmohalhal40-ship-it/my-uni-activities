<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | كشف الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Cairo', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">كشف الطلاب المسجلين</h1>
                <p class="text-gray-500">إجمالي الطلاب: <span id="student-count" class="font-bold text-blue-600">0</span></p>
            </div>
            <button onclick="fetchStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                تحديث البيانات
            </button>
        </div>

        <div class="bg-white shadow-xl rounded-2xl overflow-hidden">
            <table class="w-full text-right border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b">
                        <th class="p-4 font-bold text-gray-700">الاسم الثلاثي</th>
                        <th class="p-4 font-bold text-gray-700">اسم المستخدم</th>
                        <th class="p-4 font-bold text-gray-700">الفرقة</th>
                        <th class="p-4 font-bold text-gray-700">الشعبة</th>
                        <th class="p-4 font-bold text-gray-700">التاريخ</th>
                    </tr>
                </thead>
                <tbody id="students-table-body">
                    </tbody>
            </table>
        </div>
    </div>

<script>
const password = prompt("برجاء إدخال كلمة سر الإدارة:");
  if (password !== "Admin@2026") { // غير الباسورد براحتك
      alert("غير مسموح لك بالدخول!");
      window.location.href = "login.html";
  }
    const supabaseUrl = 'https://laddhhupcublqpbcklyn.supabase.co';
    const supabaseKey = 'sb_publishable_wMLIZBnNAXFU4lvHt8B8tA_xbgQZhEH';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function fetchStudents() {
        const tableBody = document.getElementById('students-table-body');
        tableBody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400">جاري تحميل البيانات...</td></tr>';

        try {
            // سحب البيانات بدون ترتيب معقد لتجنب الأخطاء
            const { data, error } = await _supabase
                .from('users')
                .select('*');

            if (error) throw error;

            document.getElementById('student-count').innerText = data.length;
            tableBody.innerHTML = ''; 

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="p-10 text-center">لا يوجد طلاب مسجلين حتى الآن</td></tr>';
                return;
            }

            data.forEach(student => {
                const row = `
                    <tr class="border-b hover:bg-blue-50 transition text-right">
                        <td class="p-4 text-gray-800 font-medium text-right">${student.full_name || 'بدون اسم'}</td>
                        <td class="p-4 text-gray-600 text-right">${student.username || '-'}</td>
                        <td class="p-4 text-right"><span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">الفرقة ${student.year || '?'}</span></td>
                        <td class="p-4 text-gray-600 text-right">${student.section || '-'}</td>
                        <td class="p-4 text-gray-400 text-xs text-right">مسجل</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error("Detailed Error:", error);
            alert("فشل في جلب البيانات: " + error.message);
            tableBody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-red-500">حدث خطأ أثناء التحميل</td></tr>';
        }
    }

    fetchStudents();
    </script>
</body>
</html>